import { NextRequest, NextResponse } from 'next/server'
import { prisma } from '@/lib/prisma'
import { getAdminUser } from '@/lib/adminAuth'
import { EmailService } from '@/lib/emailService'
import { InvoiceService } from '@/lib/invoiceService'

export const dynamic = 'force-dynamic'

export async function GET(request: NextRequest, { params }: { params: { id: string } }) {
  const adminUser = await getAdminUser(request)
  if (!adminUser) {
    return NextResponse.json(
      { error: 'Admin yetkisi gerekli' },
      { status: 401 }
    )
  }

  const { id } = params

  try {
    const order = await prisma.order.findUnique({
      where: { id },
      include: {
        user: {
          select: {
            name: true,
            surname: true,
            email: true,
            phone: true
          }
        },
        address: {
          select: {
            title: true,
            name: true,
            surname: true,
            email: true,
            phone: true,
            city: true,
            district: true,
            neighborhood: true,
            address: true,
            type: true
          }
        },
        items: {
          include: {
            product: {
              select: {
                name: true,
                price: true,
                images: true,
                slug: true
              }
            }
          }
        }
      }
    })

    if (!order) {
      return NextResponse.json(
        { error: 'Sipari≈ü bulunamadƒ±' },
        { status: 404 }
      )
    }

    return NextResponse.json(order)
  } catch (error) {
    console.error('Order fetch error:', error)
    return NextResponse.json(
      { error: 'Sipari≈ü bilgileri alƒ±nƒ±rken hata olu≈ütu' },
      { status: 500 }
    )
  }
}

export async function PATCH(request: NextRequest, { params }: { params: { id: string } }) {
  const adminUser = await getAdminUser(request)
  if (!adminUser) {
    return NextResponse.json(
      { error: 'Admin yetkisi gerekli' },
      { status: 401 }
    )
  }

  const { id } = params
  const body = await request.json()
  const { 
    status, 
    trackingNumber, 
    adminNotes, 
    shippingCompany,
    shippingTrackingUrl,
    reason,
    // ƒ∞ade/Deƒüi≈üim i≈ülemleri i√ßin yeni alanlar
    returnAction,
    exchangeAction,
    refundAmount,
    newProductId,
    newSize,
    newColor,
    // ‚úÖ YENƒ∞: Sipari≈ü onay sistemi
    orderAction
  } = body

  try {
    // √ñnce sipari≈üi al
    const order = await prisma.order.findUnique({
      where: { id },
      include: {
        items: {
          include: {
            product: true
          }
        },
        user: true,
        address: true
      }
    })

    if (!order) {
      return NextResponse.json({ error: 'Sipari≈ü bulunamadƒ±' }, { status: 404 })
    }

    // Sadece g√ºncellenen alanlarƒ± ayarla
    const updateData: any = {}
    if (status) updateData.status = status
    if (trackingNumber !== undefined) updateData.trackingNumber = trackingNumber
    if (adminNotes !== undefined) updateData.adminNotes = adminNotes
    if (shippingCompany !== undefined) updateData.shippingCompany = shippingCompany
    if (shippingTrackingUrl !== undefined) updateData.shippingTrackingUrl = shippingTrackingUrl

    // ‚úÖ YENƒ∞: Sipari≈ü onay/red i≈ülemleri
    if (orderAction) {
      if (orderAction === 'APPROVE') {
        updateData.status = 'APPROVED'
        updateData.adminNotes = `Sipari≈ü onaylandƒ± - ${adminNotes || 'ƒ∞≈ületme onayƒ±'}`
        console.log('‚úÖ Sipari≈ü onaylandƒ±, √∂deme emaili g√∂nderilecek')
      } else if (orderAction === 'REJECT') {
        updateData.status = 'REJECTED'
        updateData.adminNotes = `Sipari≈ü reddedildi - ${reason || adminNotes || 'Belirtilmemi≈ü'}`
        console.log('‚ùå Sipari≈ü reddedildi')
      }
    }

    // Durum deƒüi≈ütiyse ilgili tarihleri g√ºncelle
    if (status === 'SHIPPED') updateData.shippedAt = new Date()
    if (status === 'DELIVERED') updateData.deliveredAt = new Date()
    if (status === 'REJECTED') updateData.adminNotes = `Reddedildi - Sebep: ${reason || 'Belirtilmemi≈ü'}`

    // ƒ∞ade i≈ülemleri
    if (returnAction) {
      if (returnAction === 'APPROVE') {
        updateData.status = 'RETURN_APPROVED'
        updateData.returnApprovedAt = new Date()
        updateData.adminNotes = `ƒ∞ade onaylandƒ± - ${adminNotes || 'Admin onayƒ±'}`
        
        // Stok geri ekle
        for (const item of order.items) {
          await prisma.product.update({
            where: { id: item.productId },
            data: {
              stock: {
                increment: item.quantity
              }
            }
          })

          await prisma.stockMovement.create({
            data: {
              productId: item.productId,
              orderId: order.id,
              type: 'IN',
              quantity: item.quantity,
              description: `ƒ∞ade onaylandƒ± - Sipari≈ü #${order.id} i√ßin stok geri eklendi`
            }
          })
        }
      } else if (returnAction === 'REJECT') {
        updateData.status = 'RETURN_REJECTED'
        updateData.adminNotes = `ƒ∞ade reddedildi - ${adminNotes || 'Admin reddi'}`
      }
    }

    // Deƒüi≈üim i≈ülemleri
    if (exchangeAction) {
      if (exchangeAction === 'APPROVE') {
        updateData.status = 'EXCHANGE_APPROVED'
        updateData.exchangeApprovedAt = new Date()
        updateData.adminNotes = `Deƒüi≈üim onaylandƒ± - ${adminNotes || 'Admin onayƒ±'}`
        
        // Eski √ºr√ºn stokunu geri ekle
        for (const item of order.items) {
          await prisma.product.update({
            where: { id: item.productId },
            data: {
              stock: {
                increment: item.quantity
              }
            }
          })

          await prisma.stockMovement.create({
            data: {
              productId: item.productId,
              orderId: order.id,
              type: 'IN',
              quantity: item.quantity,
              description: `Deƒüi≈üim onaylandƒ± - Eski √ºr√ºn stok geri eklendi`
            }
          })
        }

        // Yeni √ºr√ºn stokunu d√º≈ü
        if (newProductId) {
          await prisma.product.update({
            where: { id: newProductId },
            data: {
              stock: {
                decrement: 1
              }
            }
          })

          await prisma.stockMovement.create({
            data: {
              productId: newProductId,
              orderId: order.id,
              type: 'OUT',
              quantity: 1,
              description: `Deƒüi≈üim onaylandƒ± - Yeni √ºr√ºn stok d√º≈ü√ºld√º`
            }
          })
        }
      } else if (exchangeAction === 'REJECT') {
        updateData.status = 'EXCHANGE_REJECTED'
        updateData.adminNotes = `Deƒüi≈üim reddedildi - ${adminNotes || 'Admin reddi'}`
      }
    }

    const updatedOrder = await prisma.order.update({
      where: { id },
      data: updateData,
      include: {
        items: {
          include: {
            product: true
          }
        },
        user: true,
        address: true
      }
    })

    // E-posta bildirimleri g√∂nder
    const customerEmail = order.user?.email || order.guestEmail
    const customerName = order.user ? `${order.user.name} ${order.user.surname}` : 
                        order.guestName && order.guestSurname ? `${order.guestName} ${order.guestSurname}` : 
                        'M√º≈üteri'

    if (customerEmail) {
      try {
        // Email servisini ba≈ülat
        EmailService.initialize({
          host: process.env.SMTP_HOST || 'smtp.gmail.com',
          port: parseInt(process.env.SMTP_PORT || '587'),
          secure: false,
          auth: {
            user: process.env.SMTP_USER || 'kavram.triko@gmail.com',
            pass: process.env.SMTP_PASS || 'yqarfkyevahfnenq'
          }
        });

        // ‚úÖ YENƒ∞: Sipari≈ü onaylandƒ±ƒüƒ±nda tek email g√∂nder (onay + √∂deme bilgileri)
        if (orderAction === 'APPROVE') {
          console.log('üìß Sipari≈ü onaylandƒ±, m√º≈üteriye tek email g√∂nderiliyor...')
          
          let invoicePdfPath: string | undefined;
          
          // PDF E-Fatura olu≈ütur
          try {
            const companyInfo = {
              name: 'Modahan ƒ∞brahim Kaya - ModaBase E-Ticaret',
              address: 'Malko√ßoƒülu Mah. 305/1 Sok. No: 17/A, Sultangazi/ƒ∞stanbul/T√ºrkiye',
              phone: '+90 536 297 12 55',
              email: 'info@modabase.com.tr',
              taxNumber: '1234567890',
              taxOffice: 'ƒ∞stanbul Vergi Dairesi'
            };

            const invoiceData = {
              order: updatedOrder,
              companyInfo
            };

            const { filePath, fileName } = await InvoiceService.generateInvoicePDF(invoiceData);
            invoicePdfPath = filePath;

            // Order'a PDF URL'ini kaydet
            await prisma.order.update({
              where: { id: order.id },
              data: {
                einvoicePdfUrl: `/invoices/${fileName}`,
                einvoiceStatus: 'SUCCESS'
              }
            });

            console.log('‚úÖ E-fatura olu≈üturuldu')
          } catch (invoiceError) {
            console.error('‚ùå E-fatura olu≈üturma hatasƒ±:', invoiceError)
          }

          // ‚úÖ Email servisini ba≈ülat - kavram.triko@gmail.com ile
          EmailService.initialize({
            host: process.env.SMTP_HOST || process.env.EMAIL_HOST || 'smtp.gmail.com',
            port: parseInt(process.env.SMTP_PORT || process.env.EMAIL_PORT || '587'),
            secure: false,
            auth: {
              user: process.env.SMTP_USER || process.env.EMAIL_USER || 'kavram.triko@gmail.com',
              pass: process.env.SMTP_PASS || process.env.EMAIL_PASS || 'yqarfkyevahfnenq'
            }
          });

          // ‚úÖ TEK EMAIL: Sipari≈ü onayƒ± + √∂deme talimatlarƒ± + e-fatura
          await EmailService.sendOrderApprovalWithPaymentInstructions({
            to: customerEmail,
            customerName,
            orderId: order.id,
            orderNumber: order.id.slice(-8),
            totalAmount: order.total,
            paymentMethod: order.paymentMethod || 'Havale/EFT',
            items: order.items.map(item => ({
              name: item.product.name,
              quantity: item.quantity,
              price: item.price
            })),
            invoicePdfPath
          })

          console.log('‚úÖ Sipari≈ü onayƒ± + √∂deme talimatlarƒ± tek mailde g√∂nderildi')
        }

        // ‚úÖ YENƒ∞: Sipari≈ü reddedildiƒüinde
        if (orderAction === 'REJECT') {
          await EmailService.sendOrderRejection({
            to: customerEmail,
            customerName,
            orderId: order.id,
            orderNumber: order.id.slice(-8),
            reason: reason || adminNotes || 'Belirtilmemi≈ü',
            totalAmount: order.total,
            items: order.items.map(item => ({
              name: item.product.name,
              quantity: item.quantity,
              price: item.price
            }))
          })

          console.log('‚úÖ Sipari≈ü red bildirimi g√∂nderildi')
        }

        // ƒ∞ade onaylandƒ±ƒüƒ±nda
        if (returnAction === 'APPROVE') {
          await EmailService.sendReturnApprovalNotification({
            to: customerEmail,
            customerName,
            orderId: order.id,
            orderNumber: order.id.slice(-8),
            refundAmount: refundAmount || order.total,
            items: order.items.map(item => ({
              name: item.product.name,
              quantity: item.quantity,
              price: item.price
            }))
          })
        }

        // ƒ∞ade reddedildiƒüinde
        if (returnAction === 'REJECT') {
          await EmailService.sendReturnRejectionNotification({
            to: customerEmail,
            customerName,
            orderId: order.id,
            orderNumber: order.id.slice(-8),
            reason: adminNotes || 'Belirtilmemi≈ü',
            items: order.items.map(item => ({
              name: item.product.name,
              quantity: item.quantity,
              price: item.price
            }))
          })
        }

        // Deƒüi≈üim onaylandƒ±ƒüƒ±nda
        if (exchangeAction === 'APPROVE') {
          await EmailService.sendExchangeApprovalNotification({
            to: customerEmail,
            customerName,
            orderId: order.id,
            orderNumber: order.id.slice(-8),
            newProductId,
            newSize,
            newColor,
            items: order.items.map(item => ({
              name: item.product.name,
              quantity: item.quantity,
              price: item.price
            }))
          })
        }

        // Deƒüi≈üim reddedildiƒüinde
        if (exchangeAction === 'REJECT') {
          await EmailService.sendExchangeRejectionNotification({
            to: customerEmail,
            customerName,
            orderId: order.id,
            orderNumber: order.id.slice(-8),
            reason: adminNotes || 'Belirtilmemi≈ü',
            items: order.items.map(item => ({
              name: item.product.name,
              quantity: item.quantity,
              price: item.price
            }))
          })
        }

        // ‚ùå KALDIRILDI: Eski otomatik √∂deme talimatlarƒ±
        // Artƒ±k sadece onay sonrasƒ± g√∂nderiliyor

      } catch (emailError) {
        console.error('E-posta g√∂nderme hatasƒ±:', emailError)
        // E-posta hatasƒ± sipari≈ü g√ºncellemesini etkilemesin
      }
    }

    let message = 'Sipari≈ü ba≈üarƒ±yla g√ºncellendi'
    if (orderAction === 'APPROVE') {
      message = 'Sipari≈ü onaylandƒ± ve m√º≈üteriye √∂deme talimatlarƒ± g√∂nderildi'
    } else if (orderAction === 'REJECT') {
      message = 'Sipari≈ü reddedildi ve m√º≈üteriye bildirim g√∂nderildi'
    }

    return NextResponse.json({
      success: true,
      message: message,
      order: updatedOrder
    })

  } catch (error) {
    console.error('Order update error:', error)
    return NextResponse.json(
      { error: 'Sipari≈ü g√ºncellenirken hata olu≈ütu' },
      { status: 500 }
    )
  }
}
